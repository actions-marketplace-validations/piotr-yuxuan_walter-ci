name: Walter
on:
  push:
    branches: '*'
  schedule:
    - cron: "28 6 * * *"
env:
  WALTER_GIT_EMAIL: ${{ secrets.WALTER_GIT_EMAIL }}
jobs:
  #############################################################################
  # Setup jobs, run in parallel and joined on setup-completed
  #############################################################################
  clojure:
    name: Install Clojure on the worker
    steps:
      - uses: DeLaGuardo/setup-clojure@master
        with:
          cli: latest
          lein: latest
  walter:
    name: Install Walter on the worker
    steps:
      - uses: engineerd/configurator@v0.0.6
          with:
            name: "walter-ci"
            pathInArchive: "./linux-walter-ci"
            fromGitHubReleases: "true"
            repo: "piotr-yuxuan/walter-ci"
            urlTemplate: "https://github.com/piotr-yuxuan/walter-ci/releases/download/{{version}}/linux-walter-ci"
            version: "latest"
            token: ${{ secrets.GITHUB_TOKEN }}
  checkout:
    name: Checkout project code
    steps:
      - uses: actions/checkout@main
        with:
          - clean: false
  print-env:
    name: Print environment variables
    steps:
      - run: env
  setup-completed:
    name: All setup jobs successful
    needs: [clojure, walter, checkout, print-env]
    steps:
      - name: Success
        run: echo

  #############################################################################
  # Jobs for Walter grooming
  #############################################################################
  code-style:
    name: Fix and report code style
    needs: setup-completed
    continue-on-error: true
    permissions:
      # We give a secret to this external action, let's make sure it
      # can't do anything bad with it.
      check: write
    steps:
      - run: walter-ci --command "lein kibit" --commit-message "Simple fixes with kibit"
      # We give a secret to this external action, let's make sure code
      # can't turn rogue.
      - uses: DeLaGuardo/clojure-lint-action@master
        with:
          clj-kondo-args: --lint dev src test
          github_token: ${{ secrets.GITHUB_TOKEN }}
  coverage:
    name: Report code coverage of test
    needs: setup-completed
    steps:
      - run: walter-ci --command --code-coverage
  conform-gh:
    name: Conform GitHub repository
    needs: setup-completed
    env:
      # Can it run on $GITHUB_TOKEN alone?
      WALTER_GITHUB_TOKEN: ${{ secrets.WALTER_GITHUB_TOKEN }}
    steps:
      - run: walter-ci --command --conform-github-repository
  ns-sort:
    name: Sort namespace forms
    needs: setup-completed
    steps:
      - run: walter-ci --command "lein ns-sort" --commit-message "Sort namespace forms"
  update:
    name: Update dependency versions
    needs: setup-completed
    steps:
      - if: ${{ github.event_name == 'schedule' }}
        run: walter-ci --command "lein ancient upgrade :all :check-clojure" --commit-message "Update dependency versions"
  licenses:
    name: List dependency licences
    needs: setup-completed
    steps:
      - if: ${{ github.event_name == 'schedule' }}
        run: walter-ci --command --list-licenses --commit-message "List dependency licences"
  vulnerabilities:
    name: Report known dependency vulnerabilities
    needs: setup-completed
    steps:
      - if: ${{ github.event_name == 'schedule' }}
        run: walter-ci --command --vulnerabilities --commit-message "Update known dependency vulnerabilities"
  documentation:
    name: Update documentation
    needs: setup-completed
    steps:
      - run: walter-ci --command --documentation --commit-message "Update documentation"
  funding:
    name: Ensure FUNDING.yml is present
    needs: setup-completed
    steps:
      - if: ${{ github.event_name == 'schedule' }}
        run: walter-ci --command --funding --commit-message "Update FUNDING.yml"
  grooming-completed:
    name: All setup jobs successful
    # FIXME: I think it's really dangerous to keep this file manually
    # authored because sooner or later I will forget to update this
    # part.
    needs: [code-style, coverage, conform-gh, ns-sort, update, licenses,
            vulnerabilities, documentation, funding, grooming-completed]
    steps:
      - name: Success
        run: echo

  #############################################################################
  # Deploy job, run after grooming jobs if all successful
  #############################################################################
  deploy:
    env:
      WALTER_GITHUB_TOKEN: ${{ secrets.WALTER_GITHUB_TOKEN }}
      WALTER_CLOJARS_TOKEN: ${{ secrets.WALTER_CLOJARS_TOKEN }}
      WALTER_CLOJARS_USERNAME: ${{ secrets.WALTER_CLOJARS_USERNAME }}
    name: Run tests, push git references, and finally deploy artifacts
    needs: grooming-completed
    steps:
      - name: Run tests
        run: walter-ci --command --test
      - name: Push Walter commits and tags to GitHub
        run: walter-ci --command --push-commits-tags
      - run: walter-ci --command --deploy
